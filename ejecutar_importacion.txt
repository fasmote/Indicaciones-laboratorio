@echo off
echo ============================================
echo ğŸš€ IMPORTACION DE DATOS REALES DEL EXCEL
echo ============================================
echo.

cd /d "C:\Users\clau\Documents\DGSISAN_2025bis\Indicaciones\indicaciones-app"

echo ğŸ“ UbicaciÃ³n actual: %CD%
echo.

REM Verificar que el archivo Excel existe
if not exist "REVISARTabla de indicaciones para pacientes actualizada 2024 enviada por la RED.xlsx" (
    echo âŒ ERROR: Archivo Excel no encontrado
    echo    AsegÃºrate de que el archivo estÃ© en la carpeta del proyecto
    pause
    exit /b 1
)

echo âœ… Archivo Excel encontrado
echo.

REM Verificar que Node.js estÃ¡ instalado
node --version >nul 2>&1
if errorlevel 1 (
    echo âŒ ERROR: Node.js no estÃ¡ instalado o no estÃ¡ en el PATH
    pause
    exit /b 1
)

echo âœ… Node.js disponible
echo.

REM Instalar dependencias si no existen
if not exist "node_modules" (
    echo ğŸ“¦ Instalando dependencias...
    npm install
    if errorlevel 1 (
        echo âŒ ERROR: FallÃ³ la instalaciÃ³n de dependencias
        pause
        exit /b 1
    )
) else (
    echo âœ… Dependencias ya instaladas
)

echo.

REM Verificar que XLSX estÃ¡ instalado
npm list xlsx >nul 2>&1
if errorlevel 1 (
    echo ğŸ“¦ Instalando librerÃ­a XLSX...
    npm install xlsx
    if errorlevel 1 (
        echo âŒ ERROR: No se pudo instalar XLSX
        pause
        exit /b 1
    )
)

echo âœ… LibrerÃ­a XLSX disponible
echo.

REM Crear el script de importaciÃ³n si no existe
if not exist "script-importacion-excel.js" (
    echo ğŸ“ Creando script de importaciÃ³n...
    echo const XLSX = require('xlsx'^); > script-importacion-excel.js
    echo const fs = require('fs'^); >> script-importacion-excel.js
    echo const path = require('path'^); >> script-importacion-excel.js
    echo. >> script-importacion-excel.js
    echo console.log('Script de importaciÃ³n creado. Usar el cÃ³digo del artefacto.'^); >> script-importacion-excel.js
)

echo ğŸ”„ Ejecutando importaciÃ³n de datos...
echo.

REM Ejecutar el script de importaciÃ³n
node script-importacion-excel.js
if errorlevel 1 (
    echo.
    echo âŒ ERROR: FallÃ³ la importaciÃ³n de datos
    echo    Revisa los mensajes de error arriba
    pause
    exit /b 1
)

echo.
echo âœ… ImportaciÃ³n completada exitosamente!
echo.

REM Verificar que se generÃ³ el archivo SQL
if not exist "datos_reales_import.sql" (
    echo âŒ WARNING: No se generÃ³ el archivo SQL esperado
    pause
    exit /b 1
)

echo ğŸ“ Archivo SQL generado: datos_reales_import.sql
echo.

REM Aplicar los datos a la base de datos
echo ğŸ—ƒï¸  Aplicando datos a la base de datos...
if exist "prisma\indicaciones.db" (
    echo    Haciendo backup de la base de datos actual...
    copy "prisma\indicaciones.db" "prisma\indicaciones_backup_%date:~-4,4%%date:~-10,2%%date:~-7,2%.db" >nul
    
    echo    Aplicando datos reales...
    type "datos_reales_import.sql" | sqlite3 "prisma\indicaciones.db"
    if errorlevel 1 (
        echo âŒ ERROR: FallÃ³ la aplicaciÃ³n de datos a la base de datos
        echo    Restaurando backup...
        copy "prisma\indicaciones_backup_*.db" "prisma\indicaciones.db" >nul
        pause
        exit /b 1
    )
    
    echo âœ… Datos aplicados exitosamente a la base de datos
) else (
    echo âŒ ERROR: Base de datos no encontrada en prisma\indicaciones.db
    echo    Ejecuta primero: npm run db:migrate
    pause
    exit /b 1
)

echo.
echo ğŸ‰ IMPORTACIÃ“N COMPLETADA EXITOSAMENTE!
echo =========================================
echo.
echo ğŸ“Š Los datos reales del Excel han sido cargados.
echo ğŸ”§ Puedes verificar con: npm run db:studio
echo ğŸš€ Ejecuta el servidor con: npm run dev
echo ğŸŒ Luego visita: http://localhost:3000
echo.
echo âœ¨ El sistema ahora tiene los datos reales de laboratorio.
echo.

pause